<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<div class="container">

    <!-- Sidebar -->
    <aside class="sidebar">
        <h2 class="logo">LocalEase</h2>

        <ul>
            <li class="active"><i class="fa-solid fa-gauge"></i> Dashboard</li>
            <li><i class="fa-solid fa-calendar-check"></i> My Bookings</li>
            <li><i class="fa-solid fa-star"></i> Saved Providers</li>
            <li><i class="fa-solid fa-money-bill-wave"></i> Payment History</li>
            <li onclick="logout()" class="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main">

        <!-- Top Bar -->
        <div class="top-bar">
            <h1>Welcome back, <span id="username">User</span> ðŸ‘‹</h1>
            <div class="badge">USER</div>
        </div>

        <!-- Stats -->
        <div class="stats">

            <div class="card">
                <div class="card-icon"><i class="fa-solid fa-calendar-days"></i></div>
                <h3>Total Bookings</h3>
                <p id="totalBookings">0</p>
            </div>

            <div class="card">
                <div class="card-icon"><i class="fa-solid fa-briefcase"></i></div>
                <h3>Active Services</h3>
                <p id="activeServices">0</p>
            </div>

            <div class="card">
                <div class="card-icon"><i class="fa-solid fa-check-circle"></i></div>
                <h3>Completed</h3>
                <p id="completedServices">0</p>
            </div>

            <div class="card">
                <div class="card-icon"><i class="fa-solid fa-wallet"></i></div>
                <h3>Pending Payment</h3>
                <p id="pendingPayment">â‚¹0</p>
            </div>

        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2>Quick Actions</h2>

            <div class="actions">
                <button onclick="location.href='book-service.html'">Book New Service</button>
                <button onclick="location.href='my-requests.html'">View My Requests</button>
                <button onclick="location.href='browse-providers.html'">Browse Providers</button>
            </div>
        </div>

        <!-- Recent Bookings -->
        <div class="recent">
            <h2>Recent Bookings</h2>

            <table id="recentBookings">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS will fill rows dynamically -->
                </tbody>
            </table>
        </div>

    </main>

</div>

<!-- ================== JS ================== -->
<script>
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");
    const userId = localStorage.getItem("userId");

    if (!token || role !== "user") {
        window.location.href = "login.html";
    }

    function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("role");
        localStorage.removeItem("userId");
        window.location.href = "login.html";
    }

    // Animate numbers
    function animateCounter(element, target, duration = 1500, prefix = "") {
        let start = 0;
        const stepTime = Math.abs(Math.floor(duration / (target || 1)));
        const timer = setInterval(() => {
            start += 1;
            element.innerText = prefix + start;
            if (start >= target) clearInterval(timer);
        }, stepTime);
    }

    // Fetch bookings and update dashboard
    fetch(`http://localhost:5000/bookings/user/${userId}`)
      .then(res => res.json())
      .then(data => {
          const total = data.length;
          const active = data.filter(b => b.status === "Active").length;
          const completed = data.filter(b => b.status === "Completed").length;
          const pending = data
              .filter(b => b.status === "Pending")
              .reduce((sum, b) => sum + Number(b.amount), 0);

          // Animate numbers
          animateCounter(document.querySelector("#totalBookings"), total);
          animateCounter(document.querySelector("#activeServices"), active);
          animateCounter(document.querySelector("#completedServices"), completed);
          animateCounter(document.querySelector("#pendingPayment"), pending, 1500, "â‚¹");

          // Update recent bookings table
          const tableBody = document.querySelector("#recentBookings tbody");
          tableBody.innerHTML = "";
          data.slice(-5).reverse().forEach(b => {
              const row = `<tr>
                              <td>${b.serviceName}</td>
                              <td>${b.date}</td>
                              <td>${b.status}</td>
                              <td>â‚¹${b.amount}</td>
                           </tr>`;
              tableBody.innerHTML += row;
          });
      })
      .catch(err => {
          console.error("Error fetching bookings:", err);
          alert("Failed to load bookings");
      });
</script>

</body>
</html>